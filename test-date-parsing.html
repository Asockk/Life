<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datum Parsing Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            background: #f0f0f0;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Datum Parsing Test</h1>
    
    <div class="test-container">
        <h2>germanDateToISO Test</h2>
        <input type="text" id="germanDate" placeholder="z.B. 21. November 2024" value="21. November 2024">
        <button onclick="testGermanDateToISO()">Test</button>
        <div id="germanDateResult"></div>
    </div>

    <div class="test-container">
        <h2>parseImportedDate Test</h2>
        <input type="text" id="weekday" placeholder="Wochentag" value="Donnerstag">
        <input type="text" id="dateStr" placeholder="Datum" value="21. November 2024">
        <button onclick="testParseImportedDate()">Test</button>
        <div id="parseResult"></div>
    </div>

    <script>
        // germanDateToISO Funktion
        const germanDateToISO = (germanDate) => {
            if (!germanDate) return '';
            
            const months = {
                'Januar': '01', 'Februar': '02', 'MÃ¤rz': '03', 'April': '04',
                'Mai': '05', 'Juni': '06', 'Juli': '07', 'August': '08',
                'September': '09', 'Oktober': '10', 'November': '11', 'Dezember': '12'
            };
            
            // Verbesserte Regex um Jahr immer zu erfassen
            const match = germanDate.match(/(\d+)\.\s*(\w+)\s*(\d{4})?/);
            if (match) {
                const day = match[1].padStart(2, '0');
                const monthName = match[2];
                const year = match[3] || new Date().getFullYear().toString();
                const month = months[monthName];
                
                if (month) {
                    const result = `${year}-${month}-${day}`;
                    console.log(`[germanDateToISO] Converting: "${germanDate}" => "${result}"`);
                    return result;
                }
            }
            
            console.warn(`[germanDateToISO] Failed to parse date: "${germanDate}"`);
            return '';
        };

        // parseImportedDate Funktion (vereinfacht)
        function parseImportedDate(weekdayStr, dateStr) {
            if (!weekdayStr || !dateStr) return null;
            
            try {
                let germanDay, germanMonth;
                let year = null;
                
                // Format: "21. November 2024"
                if (dateStr.includes('.') && dateStr.includes(' ')) {
                    const regex = /(\d+)\.\s*(\w+)\s*(\d{4})?/;
                    const match = dateStr.match(regex);
                    
                    if (match) {
                        germanDay = match[1];
                        germanMonth = match[2];
                        year = match[3] || null;
                    }
                }
                
                if (germanMonth && germanDay) {
                    const formattedDate = year 
                        ? `${germanDay}. ${germanMonth} ${year}` 
                        : `${germanDay}. ${germanMonth}`;
                    
                    return {
                        formattedDate,
                        tagKurz: weekdayStr.substring(0, 2)
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Error parsing date:', error);
                return null;
            }
        }

        function testGermanDateToISO() {
            const input = document.getElementById('germanDate').value;
            const result = germanDateToISO(input);
            const resultDiv = document.getElementById('germanDateResult');
            
            if (result) {
                resultDiv.innerHTML = `
                    <div class="test-result success">
                        <strong>Erfolg!</strong><br>
                        Eingabe: ${input}<br>
                        ISO-Format: ${result}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="test-result error">
                        <strong>Fehler!</strong><br>
                        Konnte "${input}" nicht parsen.
                    </div>
                `;
            }
        }

        function testParseImportedDate() {
            const weekday = document.getElementById('weekday').value;
            const dateStr = document.getElementById('dateStr').value;
            const result = parseImportedDate(weekday, dateStr);
            const resultDiv = document.getElementById('parseResult');
            
            if (result) {
                resultDiv.innerHTML = `
                    <div class="test-result success">
                        <strong>Erfolg!</strong><br>
                        Wochentag: ${weekday}<br>
                        Datum: ${dateStr}<br>
                        Formatiert: ${result.formattedDate}<br>
                        Tag kurz: ${result.tagKurz}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="test-result error">
                        <strong>Fehler!</strong><br>
                        Konnte nicht parsen.
                    </div>
                `;
            }
        }

        // Teste beim Laden
        window.onload = () => {
            testGermanDateToISO();
            testParseImportedDate();
        };
    </script>
</body>
</html>